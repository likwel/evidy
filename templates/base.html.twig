<!DOCTYPE html>
<html>
	<head>
		<title>e-vidy</title>
		<link href="{{asset('css/okcss.css')}}" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css" rel="stylesheet"

		{% block stylesheets %} {% endblock %}
		{% block javascripts %}{% endblock %}
	</head>
	<body>

		{% block body %}{% endblock %}

	</body>
	<script>
	/*const toastTriggerMsg = document.querySelector("a[id^='onmessage_']")
	const toastLiveMsg = document.getElementById('liveToastMsg')
	
	if (toastTriggerMsg) {
	toastTriggerMsg.addEventListener('click', () => {
		const toast = new bootstrap.Toast(toastLiveMsg)
		toast.show()
		getMessage();
	})
	}*/
	const toastTriggerMsg = document.getElementById('liveToastBtnMsg')
	
	if (toastTriggerMsg) {
	toastTriggerMsg.addEventListener('click', () => {
		console.log("message clicked...")

		setIsShow();

		getMessage();

	})
	}
	const toastTriggerNotif = document.getElementById('liveToastBtnNotif')
	if (toastTriggerNotif) {
	toastTriggerNotif.addEventListener('click', () => {
		console.log("notification clicked...")
	})
	}
	const toastTriggerCart= document.getElementById('liveToastBtnCart')
	if (toastTriggerCart) {
	toastTriggerCart.addEventListener('click', () => {
		console.log("Cart clicked...")
	})
	}

	const toastTriggerProfil= document.getElementById('liveToastBtnProfil')
	const toastLiveProfil = document.getElementById('liveToastProfil')
	if (toastTriggerProfil) {
	toastTriggerProfil.addEventListener('click', () => {
		const toast = new bootstrap.Toast(toastLiveProfil)
		toast.show()
		
	})
	}

	const evtSourceNotif = new EventSource("/user/notifications");
	evtSourceNotif.onmessage = function(event) {
        const dataset = JSON.parse(event.data);
		if(dataset == 0){
			document.querySelector("#nb_notif").style.display = "none"
		}
		else if(dataset<=9){
			document.querySelector("#nb_notif").textContent = dataset
		}else{
			document.querySelector("#nb_notif").textContent = 9+"+"
		}
		//console.log(" dataset : "+dataset);
	}

	const evtSourceMsg = new EventSource("/user/messages");
	evtSourceMsg.onmessage = function(event) {
        const dataset = JSON.parse(event.data);
		if(dataset == 0){
			document.querySelector("#nb_message").style.display = "none"
		}
		else if(dataset<=9){
			document.querySelector("#nb_message").textContent = dataset
		}else{
			document.querySelector("#nb_message").textContent = 9+"+"
		}
		//console.log(" dataset : "+dataset);
	}

	const evtSourceCart = new EventSource("/user/cartes");
	evtSourceCart.onmessage = function(event) {
        const dataset = JSON.parse(event.data);
		if(dataset == 0){
			document.querySelector("#nb_carte").style.display = "none"
		}
		else if(dataset<=9){
			document.querySelector("#nb_carte").textContent = dataset
		}else{
			document.querySelector("#nb_carte").textContent = 9+"+"
		}
		//console.log(" dataset : "+dataset);
	}

	function getMessage(){
		fetch("/user/get_messages", {
			method: "GET",
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			}
		}).then(response => response.json()).then(data=>{
			if(data=="Aucun message"){
				document.querySelector("#message_body").innerHTML = data;
			}else if(data.length>0){

				let res ="";
				for(let d of data){
					let isRead = d.isRead == 0 ? "bg-info-subtle" :"";
					if(d.content.length > 50){
						let substr = d.content.substring(0, 50)
						res +=`<div class="row message_box w-100 m-auto mb-2 ${isRead}"> <span onclick="openMsg(${d.id},${d.user_id})"><i class="col-2 bi bi-person-circle m-1 text-primary"> Elie Fenohasina</i><p class="col-10">${substr}...</p></span> </div>`
				
					}else{
						res +=`<div class="row message_box w-100 m-auto mb-2 ${isRead}"> <span onclick="openMsg(${d.id},${d.user_id})"><i class="col-2 bi bi-person-circle m-1 text-primary"> Elie Fenohasina</i><p class="col-10">${d.content}</p></span> </div>`
					}
				}
				document.querySelector("#message_body").innerHTML = `<div class="list-group">` +res + '</div>';
			}else{
				document.querySelector("#message_body").innerHTML = data;
			}
		})
	}

	function openMsg(id, user_id){

		console.log("receiver_id : "+user_id)

		setIsRead(user_id);

		const evtSourceMessage = new EventSource("/user/get_messages_by_id/"+user_id);
		evtSourceMessage.onmessage = function(event) {
			const message = JSON.parse(event.data);

			if(message.length>0){
				let res_me = ""
				let res_other = ""
				let total =""

				let user = "";

				for(let msg of message){
					user = msg.user_id;
					if(msg.isForMe == 1){
						res_me +=`<div class="d-flex flex-row justify-content-start">
							<img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
							<div id="my_message">
								<p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">${msg.content}</p>
							</div>
						</div>`
					}else{
						res_me+=`<div class="d-flex flex-row justify-content-end mb-4 pt-1">
						<div id="other_message">
							<p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">${msg.content}</p>
						</div>
						<img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
					</div>`

					}
					
				}

				document.querySelector("#user_id").value = user;

				document.querySelector("#all_message").innerHTML = res_me;
			}else{
				console.log("message : "+message)
			}
			
		}
		
		document.querySelector("#chat").style.display="block"

	}

	function quitMsg(){
		document.querySelector("#chat").style.display="none"
		
	}

	function setIsShow(){
		fetch(new Request("/user/setIsShow", {
			method: "POST",
			headers: {
			'Accept': 'application/json',
			'Content-Type': 'application/json'
			}
			})).then(req => req.json()).then(message => {
				console.log(message);
		})
	}

	function setIsRead(user_id){
		fetch(new Request("/user/setIsRead/"+user_id, {
			method: "POST",
			headers: {
			'Accept': 'application/json',
			'Content-Type': 'application/json'
			}
			})).then(req => req.json()).then(message => {
				console.log(message);
		})
	}

	</script>
</html>
